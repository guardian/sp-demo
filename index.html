<html>
  <head>

    <!-- sourcepoint stub . See https://documentation.sourcepoint.com/web-implementation/sourcepoint-setup-and-ccpa-configuration -->
    <script type="text/javascript">(function () { var e = false; var c = window; var t = document; function r() { if (!c.frames["__uspapiLocator"]) { if (t.body) { var a = t.body; var e = t.createElement("iframe"); e.style.cssText = "display:none"; e.name = "__uspapiLocator"; a.appendChild(e) } else { setTimeout(r, 5) } } } r(); function p() { var a = arguments; __uspapi.a = __uspapi.a || []; if (!a.length) { return __uspapi.a } else if (a[0] === "ping") { a[2]({ gdprAppliesGlobally: e, cmpLoaded: false }, true) } else { __uspapi.a.push([].slice.apply(a)) } } function l(t) { var r = typeof t.data === "string"; try { var a = r ? JSON.parse(t.data) : t.data; if (a.__cmpCall) { var n = a.__cmpCall; c.__uspapi(n.command, n.parameter, function (a, e) { var c = { __cmpReturn: { returnValue: a, success: e, callId: n.callId } }; t.source.postMessage(r ? JSON.stringify(c) : c, "*") }) } } catch (a) { } } if (typeof __uspapi !== "function") { c.__uspapi = p; __uspapi.msgHandler = l; c.addEventListener("message", l, false) } })();</script>

    <script>
      // Trying that just after the stub.
      function fetchUSPdata(){
          // query getUSPData
          if( window.__uspapi ){
              window.__uspapi('getUSPData', 2,
                              (uspData, success) => {
                                  console.log("getUSPData: ", uspData,success);
                              });
          }else{
              console.log("No __uspapi :/");
          }
      }
    </script>

    
    <!-- Our config -->
    <script>
      var accountId = 1257;
      var genericCallback = function(eName){
          return function(){ console.log("CALLBACK "+ eName + " WITH:" , arguments); };
      }
      

      // Callbacks from https://documentation.sourcepoint.com/web-implementation/sourcepoint-set-up-and-configuration-v2/optional-callbacks
      // Events when we know about the consent
      // onMessageChoiceSelect , onConsentReady

      // The callback settings for the config
      var events = {};

      /* Not needed unless you want to better understand all the events.
      var callbackEvents = ['onMessageReady','onMessageChoiceSelect',
                            'onMessageReceiveData','onMessageChoiceError',
                            'onPrivacyManagerAction','onConsentReady', 'onPMCancel',
                            'onSPPMObjectReady'];
      // Generic event handling
      callbackEvents.forEach( (eName) => {
          events[eName] = genericCallback( eName );
      });
      */
      // The specific events where the consent can change.
      ['onMessageChoiceSelect','onConsentReady'].forEach( (eName) => {
          events[eName] = function(){
              console.log("CONSENT CHANGING OR INFO EVENT " + eName );
              setTimeout(fetchUSPdata, 1); // Make that asynchronous to guarantee having the right data right after a reject.
          };
      });
      
      
      window._sp_ccpa = {
          config: {
              mmsDomain: 'https://message.sp-prod.net',
              ccpaOrigin: 'https://ccpa-service.sp-prod.net',
              accountId,
              getDnsMsgMms: true,
              alwaysDisplayDns: false,
              siteHref: 'http://theguardian.eteve.net',
              events,
          },
      };


      function showPM(){
          window._sp_ccpa.loadPrivacyManagerModal(null, '5eba7ef78c167c47ca8b433d');
      }
      
    </script>

    <!-- Sourcepoint call code -->
    <script src="https://ccpa.sp-prod.net/ccpa.js"></script>
    
  </head>
  <body>
    
    <h1>Hello CCPA world</h1>
    
    <p>
      <em>Note: Clear all this domain cookies to see the CCPA message banner again.</em>
    </p>

    <p>
      <a href="#" onClick="showPM()">Show Privacy Manager</a>
    </p>
    
</boby>
</html>
